---
- name: "Add new sudo user {{ MAIN_USERNAME }}"
  ansible.builtin.user:
    name: "{{ MAIN_USERNAME }}"
    state: present
    groups: sudo,adm,systemd-journal
    append: true

- name: "Add new sudo user to sudoers"
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    line: "{{ MAIN_USERNAME }} ALL=(ALL) NOPASSWD:ALL"
    state: present
    validate: 'visudo -cf %s'

- name: Copy authorized_keys
  block:
    - name: Create .ssh directory
      ansible.builtin.file:
        path: "/home/{{ MAIN_USERNAME }}/.ssh"
        state: directory
        owner: "{{ MAIN_USERNAME }}"
        group: "{{ MAIN_USERNAME }}"
        mode: '0700'

    - name: Copy authorized_keys
      ansible.posix.authorized_key:
        user: "{{ MAIN_USERNAME }}"
        state: present
        key: "{{ lookup('file', '~/.ssh/authorized_keys') }}"

- name: Disable password login
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present
    validate: 'sshd -t -f %s'

- name: Remove user
  ansible.builtin.user:
    user: name=$USER
    state: absent
  become: true
  become_method: sudo
  when: $USER != $MAIN_USERNAME and $USER != "root"
